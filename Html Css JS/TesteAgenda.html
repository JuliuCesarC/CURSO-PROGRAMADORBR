<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Calendário</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Comfortaa:wght@300&display=swap");
            @import url("https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&display=swap");
        </style>
        <link rel="stylesheet" href="TesteAgenda.css" />
    </head>
    <body>
        <div class="container">
            <div class="Table">
                <header class="Header">
                    <button class="btn-prev" id="Btn-Prev">&lt;</button>
                    <h2 id="month">Outubro</h2>
                    <button class="btn-next" id="Btn-Next">&gt;</button>
                </header>
                <table>
                    <thead>
                        <tr>
                            <td>D</td>
                            <td>S</td>
                            <td>T</td>
                            <td>Q</td>
                            <td>Q</td>
                            <td>S</td>
                            <td>S</td>
                        </tr>
                    </thead>
                    <tbody id="days"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="7" id="year">2022</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="Cont" id="ToDo">
                <header>
                    <img
                        src="../React/Hooks/ViteHooks/public/img/Caderno.png"
                        alt=""
                    />
                    <h2>ToDo List</h2>
                </header>
                <div id="Teste" class="working">
                    Lorem ipsum, dolor sit amet consectetur adipisicing elit.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit.
                    Maiores magnam rem harum optio blanditiis ut id excepturi,
                    tempore sapiente enim fugit maxime cupiditate ab nisi iste
                    aliquam cum fugiat vero.
                </div>
                <div class="check">
                    Lorem ipsum dolor sit amet consectetur adipisicing elit.
                </div>
            </div>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const months = [
                    { month: "janeiro" },
                    { month: "fevereiro" },
                    { month: "março" },
                    { month: "abril" },
                    { month: "maio" },
                    { month: "junho" },
                    { month: "julho" },
                    { month: "agosto" },
                    { month: "setembro" },
                    { month: "outubro" },
                    { month: "novembro" },
                    { month: "dezembro" },
                ];
                if (!localStorage.getItem("ToDoList")) {
                    localStorage.setItem("ToDoList", JSON.stringify(months));
                }
                const LS = JSON.parse(localStorage.getItem("ToDoList"));
                const Days = document.getElementById("days");

                function inputTask(target) {
                    let Tbody = target.parentNode.parentNode.dataset;
                    let TaskList = {
                        month: Tbody.month,
                        year: Tbody.year,
                        day: target.innerHTML,
                        tasks: [
                            "Lorem ipsum dolor sit",
                            "Amet consectetur adipisicing elit.",
                        ],
                    };
                    let taskLS = JSON.parse(localStorage.getItem("ToDoList"))[
                        Tbody.month
                    ];
                    if (!taskLS.taskList) {
                        taskLS.taskList = [];
                    }
                    taskLS.taskList.push(TaskList);
                    LS[Tbody.month] = taskLS;
                    localStorage.setItem("ToDoList", JSON.stringify(LS));
                    if (!target.classList[0]) {
                        target.classList.add("task");
                    } else {
                        target.classList.remove("task");
                    }
                }

                function randomID() {
                    return Math.random().toString(36).substring(2, 9);
                }
                // LIMPA A TABELA QUANDO MUDA O MÊS
                function clearTable() {
                    let allTr = Array.from(document.querySelectorAll("tr"));
                    allTr.slice(1, -1).forEach((el) => {
                        Days.removeChild(el);
                    });
                }
                function clearTasks() {
                    let allTk = Array.from(
                        document
                            .getElementById("ToDo")
                            .getElementsByTagName("div")
                    );
                    allTk.forEach((el) => {
                        document.getElementById("ToDo").removeChild(el);
                    });
                }
                clearTasks();

                function showTasks() {
                    let divCont = document.getElementById("ToDo");

                    if (divCont.children.length <= 1) {
                        let emptyDiv = document.createElement("div");
                        emptyDiv.classList.add("empty");
                        emptyDiv.innerHTML =
                            "Clique duas vezes para adicionar uma tarefa...";
                        emptyDiv.addEventListener("dblclick", openEditMode);
                        divCont.appendChild(emptyDiv);
                    }

                    function openEditMode(e) {
                        let elem = e.target;
                        if (elem.classList == "empty") {
                            elem.innerHTML = "";
                        }
                        let elemText = elem.innerHTML;
                        elem.innerHTML = "";
                        elem.classList.remove("empty");
                        
                        let inputTx = document.createElement("input");
                        let inputBtn = document.createElement("input");
                        inputTx.setAttribute("type", "text");
                        inputTx.setAttribute("maxlength", "100");
                        inputTx.setAttribute("value", elemText);
                        inputTx.id = "inputText";
                        inputTx.classList.add("inputTx");
                        inputBtn.classList.add("inputBtn");
                        inputBtn.setAttribute("type", "submit");
                        inputBtn.addEventListener("click", addNewTask);
                        elem.appendChild(inputTx);
                        elem.appendChild(inputBtn);
                        inputTx.focus();
                        elem.removeEventListener(switchCheck);
                        
                        function addNewTask(inp) {
                            let Text = document.getElementById("inputText");
                            if (!Text.value == "") {
                                elem.innerHTML = Text.value;
                                elem.classList.add("working");
                                elem.addEventListener("click", switchCheck);
                            }
                            return;
                        }
                        function switchCheck(e) {
                            console.log(e);
                            if (e.target.classList == "working") {
                                e.target.classList.remove("working");
                                e.target.classList.add("check");
                            } else {
                                e.target.classList.add("working");
                                e.target.classList.remove("check");
                            }
                        }
                    }
                }
                showTasks();

                // FUNÇÃO PARA INSERIR OS DIAS NA TABELA
                function showDays(month, year) {
                    // CONFIGURA O MÊS E O ANO NA TABELA
                    document.getElementById("month").innerHTML =
                        months[month].month;
                    document.getElementById("year").innerHTML = year;
                    Days.dataset.month = month;
                    Days.dataset.year = year;

                    let fistDayOfWeek = new Date(year, month, 1).getDay() - 1;
                    // É preciso colocar o -1 no final do 'fistDayOfWeek' pois durante o loop ele ira passar pelo valor 0, e como o valor 0 também é considerado, então teríamos 8 dias na semana.
                    let totalDaysInMonth = new Date(
                        year,
                        month + 1,
                        0
                    ).getDate();
                    let i = -fistDayOfWeek;
                    let tr = document.createElement("tr");
                    for (index = 1; index <= 42; i++, index++) {
                        let indexDay = new Date(year, month, i);
                        let Now = new Date();

                        let td = document.createElement("td");
                        td.innerHTML = indexDay.getDate();
                        td.addEventListener("click", (e) => {
                            showTasks(e.target);
                        });
                        if (
                            indexDay.getFullYear() == Now.getFullYear() &&
                            indexDay.getMonth() == Now.getMonth() &&
                            indexDay.getDate() == Now.getDate()
                        ) {
                            td.classList.add("current-day");
                        }
                        if (i < 1) {
                            td.classList.add("prev-month");
                        }
                        if (i > totalDaysInMonth) {
                            td.classList.add("next-month");
                        }
                        tr.appendChild(td);
                        if (index % 7 === 0 && index < 40) {
                            Days.appendChild(tr);
                            tr = document.createElement("tr");
                        }
                    }
                    Days.appendChild(tr);
                }
                let Now = new Date();
                let month = Now.getMonth();
                let year = Now.getFullYear();
                showDays(month, year);

                document.getElementById("Btn-Next").onclick = function () {
                    month++;
                    if (month > 11) {
                        month = 0;
                        year++;
                    }
                    clearTable();
                    showDays(month, year);
                };
                document.getElementById("Btn-Prev").onclick = function () {
                    month--;
                    if (month < 0) {
                        month = 11;
                        year--;
                    }
                    clearTable();
                    showDays(month, year);
                };
            });
        </script>
    </body>
</html>
